<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>leojs</title>
	<link rel="stylesheet" href="css/main.css">
	<link rel="stylesheet" href="css/ui.main.css">
	<style>
	*{
		-webkit-box-sizing: border-box;
		-moz-box-sizing: border-box;
		box-sizing: border-box;
		background-color: #fff;
	}
	body{
		background-color: #ddd;
		padding:20px;
	}
	#table{
		width:1000px;
		height:600px;
		/*border:1px solid red;*/
		margin:10px auto;
	}
	.left{
		width:200px;
		height:600px;
	}
	.right{
		width:800px;
		height:600px;
	}
	.table{
		height:400px;
	}
	.game-board{
		height:200px;
		width:600px;
		overflow-y:scroll; 
	}
	.poker-card{
		width:150px;
	}
	.btn{
		margin-bottom: 10px;
		margin-left: 10px;
		width:100px;
		padding:10px;
		background-color: #007aff;
		color:white;
		border:none;
		border-radius:5px;
	}
	.total-score,
	.bet-score{
		margin-left: 10px;
	}
	.mask{
		position: fixed;
		height:100%;
		width:100%;
		text-align: center;
		line-height: 600px;
		background-color: #000;
		color:#fff;
		font-size: 20px;
		top:0;
		left:0;
	}
	</style>
</head>
<body>
<div id="table" class="clear">
	<div class=" fl left bor-r">
		<h3>BONUS</h3>
		<div><span>五　条：</span><span class="bonus-i wt" data-type="wt"></span></div>
		<div><span>同花顺：</span><span class="bonus-i ths" data-type="ths"></span></div>
		<div><span>四　条：</span><span class="bonus-i St" data-type="St"></span></div>
		<div><span>葫　芦：</span><span class="bonus-i hl" data-type="hl"></span></div>
		<div><span>同　花：</span><span class="bonus-i th" data-type="th"></span></div>
		<div><span>顺　子：</span><span class="bonus-i sz" data-type="sz"></span></div>
		<h3>战绩</h3>
		<div><span>赢场数：</span><span class="bonus-i winCount"></span></div>
		<div><span>总场数：</span><span class="bonus-i totalCount"></span></div>
		<div><span>胜　率：</span><span class="bonus-i winPercent"></span></div>
		<div><span>总赢分：</span><span class="bonus-i winTotalScore"></span></div>
		<div><span>总输分：</span><span class="bonus-i lostTotalScore"></span></div>
	</div>
	<div class="fl right">
		<div class="table bor-b flex x-around y-center">

		</div>
		<div class="flex">
			<div class="game-board pad flex dir-bt">
				
			</div>
			<div class="btn-box">
				押分：<span class="bet-score">0</span><br>
				总分：<span class="total-score"></span><br>
				<button class="btn" id="bet">押分</button>
				<button class="btn" id="clearBet">重押</button>
				<button class="btn" id="start">开始</button>
			</div>
		</div>
	</div>
</div>

<div class="mask">正在加载，请稍候......</div>
<script src="js/vue.js"></script>
<script src="js/leo.js"></script>
<script src="js/leo.editor.js"></script>
<script src="js/bmob-min.js"></script>
<script src="js/bmob.js"></script>
<script>
//缓存图片
function loadImg(){
	var imgs = [];
	var a = new Image();
	a.src = 'poker/bg.png';
	imgs.push(a);
	var b = new Image();
	b.src = 'poker/z14.png';
	imgs.push(b);
	var c = new Image();
	c.src = 'poker/z15.png';
	imgs.push(c);
	for(var j = 0; j < 4; j++){
		for(var i = 1; i < 14; i++){
			var p = ['f','h','t','y'][j] + i;
			var img = new Image();
			img.src = 'poker/'+p+'.png';
			imgs.push(img);
		}
	}

	var suc = 0;
	imgs.each(function(i){
		this.onload = function(){
			suc++;
			if(suc>=51){
				l._class('mask').css('display','none');
			}
		}
	})
}
loadImg();
// var a = '00333';
// var reg = new RegExp('(0{3}3{2}|0{2}3{3})');
// alert(reg.test(a));
//同花顺，四条，葫芦，同花，顺子，三条，二对，一对，散牌
(function(){
	//需要储存的数据
	//皮子
	var	bonus = l.store.get('bonus') ? l.store.get('bonus').toJson():{
		wt:0,
		ths:0,
		St:0,
		hl:0,
		th:0,
		sz:0
	}

	var totalScore = l.store.get('totalScore') ? ~~l.store.get('totalScore') : 1000;//初始游戏分

	var winCount = l.store.get('winCount') ? ~~l.store.get('winCount') : 0;//赢的局数
	var totalCount = l.store.get('totalCount') ? ~~l.store.get('totalCount') : 0;//总局数
	var winTotalScore = l.store.get('winTotalScore') ? ~~l.store.get('winTotalScore') : 0;//总共赢过多少分
	var lostTotalScore = l.store.get('lostTotalScore') ? ~~l.store.get('lostTotalScore') : 0;//总共输过多少分


	//一般的游戏数据
	var pokerType = {
		wt:500,
		//还差一个同花大顺
		ths:140,
		St:60,
		hl:12,
		th:8,
		sz:6,
		st:3,
		ld:2,
		yd:1,
		sp:0
	}
	var gameCount = 1;
	var isSz = false;//是否为顺子
	var currentType = 'sp';//当前牌形
	var typeName = '散牌';
	var betScore = 0;//每局用分
	var btnStr = ['开始','换牌','结算'];
	var pokerArr = [];
	var pokers = [];
	var pokerCard = [];//牌的画面,175行有绑定事件
	var poker = [];//游戏开始后拿到的牌
	var step = 1;//游戏步骤
	/**
	 * 获取一副新牌
	 * @return {arr} 新的牌的数组，54张
	 */
	function getNewPoker(){
		if(pokers.length == 0){
			// pokers = ['p1','p2'];
			var type = ['h','f','t','y'];
			for(var j = 0; j < type.length; j++){
				for(var i = 0; i < 13; i++){
					pokers.push(type[j]+(i+1))
				}
			}
			// pokers.push('p1','p2');//暂时不添加大小王
			pokers.shuffle();
		}else{
			pokers.shuffle();
		}
		return pokers.shuffle().slice(0);
	}
	//数据渲染
	function dataRender(){
		bonus.each(function(i){
			l._class(i).html(this);
		})

		l._class('total-score').html(totalScore);
		l._class('totalCount').html(totalCount);
		l._class('winCount').html(winCount);

		var per = totalCount == 0 ? 0 : winCount / totalCount;
		l._class('winPercent').html((per * 100).toFixed(2) + "%");
		l._class('winTotalScore').html(winTotalScore);
		l._class('lostTotalScore').html(lostTotalScore);
		
		//储存数据
		l.store.add('bonus',l.jsonToStr(bonus));
		l.store.add('totalScore',totalScore);
		l.store.add('totalCount',totalCount);
		l.store.add('winCount',winCount);
		l.store.add('winTotalScore',winTotalScore);
		l.store.add('lostTotalScore',lostTotalScore);
	}
	/**
	 * 初始化界面
	 * @return {[type]} [description]
	 */
	function initPoker(){
		pokerArr = getNewPoker();
		for(var i = 0 ; i < 5; i++){
			pokerCard.push(l.create({
				tag:'img',
				attr:{
					src:'poker/bg.png'
				},
				_class:'poker-card',
				parent:l._class('table')
			}).data({index:i,status:0}))
		}

		dataRender();
	}
	initPoker();


//游戏UI逻辑开始
	/**
	 * 换牌
	 * @return {[type]} [description]
	 */
	function change(){
		if(step != 2) return;
		var src = '';
		if(this.dataset['status'] == 0){
			this.dataset['status'] = 1;
			src = 'bg';
		}else{
			this.dataset['status'] = 0;
			src = poker[this.dataset['index']];
		}
		this.src = 'poker/' + src + '.png';
	}
	
	//为pokerCard的每一个元素绑定事件
	pokerCard.each(function(){
		this.on('click',change)
	})

	/**
	 * 开始游戏
	 * @return {[type]} [description]
	 */
	function startGame(){
		poker = pokerArr.splice(0,5);
		pokerCard.each(function(i){
			this.dom.src = 'poker/' + poker[i] + '.png';
		})
	}

	/**
	 * 换牌步骤换牌
	 * @return {[type]} [description]
	 */
	function changeCard(){

		pokerCard.each(function(i){
			if(this.data('status') == 1){
				poker.splice(i,1,pokerArr.splice(0,1)[0])
			}
			this.dom.src = 'poker/' + poker[i] + '.png';
		})
	}
	/**
	 * 重开一局
	 * @return {[type]} [description]
	 */
	function initGame(){
		pokerArr = getNewPoker();
		poker = [];
		currentType = 'sp';
		typeName = '散牌';
		isSz = false;
		pokerCard.each(function(){
			this.dom.src = 'poker/bg.png'
			this.data('status',0)
		})
	}

//游戏UI逻辑结束

//游戏逻辑开始
	function wutiao(arr,min){
		var arr = arr.slice(0);
		arr.each(function(i){
			arr[i] += ~~min;
		});
		var reg = new RegExp("("+min+"{4}(14|15)|"+min+"{3}1415)");
		return reg.test(arr.join(''));
	}
	function isTh(arr){
		var f = arr.sort()[0];
		var reg = new RegExp("("+f+"{5}|"+f+"{4}z|"+f+"{3}z{2})");
		return reg.test(arr.join(''));
	}

	//暂时选定判断顺子
	// function isSz2(arr,min){
	// 	var x = arr.max() + min;
		
	// 	var reg = /(01234|09101112|0234|0134|0124|0123|0101112|091112|091012|091011)/;
	// 	if((arr.join('') == '01234') || (arr.join('') == '09101112')) return true;
	// 	if(reg.test(arr.join('')) && (x == 14 || x == 15)) return true;
	// 	return false;
	// }
	function sitiao(arr){
		var max = arr.max();
		var reg = new RegExp('(0{4}'+max+'{1}|0{1}'+max+'{4})');
		return reg.test(arr.join(''));	
	}
	function hulu(arr){
		var max = arr.max();
		var reg = new RegExp('(0{3}'+max+'{2}|0{2}'+max+'{3})');
		return reg.test(arr.join(''));
	}
	
	function santiao(arr){
		var max = arr.max();
		var reg = new RegExp(arr[2]+'{3}');
		return reg.test(arr.join(''));
	}
	function checkScore(){
		var err = false;
		if(betScore == 0){
			err = '请押分';
		}
		if(totalScore <= 0){
			err = '分数不够';
		}

		if(err){
			alert(err);
			return false;
		}
		return true;
	}
	//分辨牌形
	function readPoker(){
		var num = [];
		var flower = [];
		// poker = ['y1','y2','z3','y5','y4'];//同花顺
		// poker = ['t1','t12','t13','t11','t10'];//同花顺
		// poker = ['t4','z14','h4','f4','y4'];//四条
		// poker = ['t1','y3','h2','h1','f1'];//三条
		// poker = ['t2','t4','f2','h4','y4'];//葫芦
		// poker = ['z14','t5','h2','t3','t4'];//顺子
		// poker = ['t1','t6','z15','t13','z14'];//同花
		// poker = ['t5','f6','y3','h5','t6'];//两对
		// poker = ['t5','h3','y4','f5','f2'];//一对
		poker.each(function(i){
			// alert(this)
			flower.push(this.charAt(0))
			num.push(this.slice(1));
		})
		num.sort(function(a,b){return a-b});


		
		//判断是否为顺子
		var min = num.min();
		num.each(function(i){
			num[i] -= min;
		})

		isSz = (num.join('') == '01234') || (num.join('') == '09101112');

		// console.log(num)
		var combo = 0;
		var dz = 0;
		for(var i = 1; i < 5; i++){
			if(num[i-1] == num[i]){
				combo++;
			}
		}
		if(wutiao(num,min)){
			currentType = 'wt';
			typeName = '五条';
		}else if(isTh(flower) && isSz){
			currentType = 'ths';
			typeName = '同花顺';
		}else if(combo == 3 && sitiao(num)){
			currentType = 'St';
			typeName = '四条';
		}else if(hulu(num)){
			currentType = 'hl';
			typeName = '葫芦';
		}else if(isTh(flower)){
			currentType = 'th';
			typeName = '同花';
		}else if(isSz){
			currentType = 'sz';
			typeName = '顺子';
		}else if(santiao(num)){
			currentType = 'st';
			typeName = '三条';
		}else if(combo == 2){
			currentType = 'ld';
			typeName = '两对';
		}else if(combo == 1 && ((num.findRepeat()[0]+~~min) >= 10 || (num.findRepeat()[0]+~~min) == 1)){
			currentType = 'yd';
			typeName = '一对';
		}
	}

	//得分逻辑
	var gameBoard = l._class('game-board');
	function getScore(){
		var winScore = pokerType[currentType] * betScore;
		totalScore += winScore;
		

		//判断是否能获得Bonus的分
		var bonusInfo = '';
		var bonusScore = 0;
		if(currentType in bonus){
			bonusInfo = '<div><span style="color:#007aff">赢得 </span> <span style="color:orange; font-size:20px;"> ' + typeName + ' 的皮子</span> <span style="color:green;"> ' + bonus[currentType] + ' </span></div>';
			bonusScore = bonus[currentType];
			bonus[currentType] = 0;
			totalScore += bonusScore;
		}

		l._class('total-score').html(totalScore);

		var color = currentType == 'sp' ? 'red' : 'green';
		var str = currentType == 'sp' ? '输了' : '赢得';
		var wrap = l.create({
			tag:'div',
			content:'<div>第<span style="color:#007aff;">'+gameCount+'</span>把:<span style="color:#007aff;padding:0 10px;"> '+typeName+' </span>'+str+'<span style="color:'+color+';">'+(winScore|| betScore)+'</span></div>' + bonusInfo,
		})
		gameBoard.append(wrap,0);

		gameCount++;

		totalCount++;
		(currentType != 'sp') && winCount++;
		currentType == 'sp' ? lostTotalScore += betScore : winTotalScore += winScore - betScore;
		winTotalScore += bonusScore;

		//每局结束长皮子
		//每局每个皮子随机长1－3分
		bonus.each(function(i){
			bonus[i] += Math.round(Math.random() * 2) + 1;
		})
	}


	// 运行游戏
	function run(){	
		switch(step){
			case 1:
				if(!checkScore()) return;

				//总分小于押的分数时，直接减总分
				if(betScore > totalScore){
					betScore = totalScore;
					l._class('bet-score').html(betScore);	
				} 

				totalScore -= betScore ;
				l._class('total-score').html(totalScore);
				startGame();
				break;
			case 2:
				changeCard();
				readPoker();
				break;
			case 3:
				getScore();
				dataRender();
				initGame();
				break;
		}

		step = step < 3 ? step + 1 : 1;
		l.id('start').dom.innerHTML = btnStr[step - 1];		
	}
	//押分
	function addBetScore(){
		if(step != 1) return;
		if(betScore < totalScore){
			(betScore < 100) && (betScore+=10);
			l._class('bet-score').html(betScore);
		}else{
			alert('分数不够');
		}
	}
	//清除押的份
	function clearBetScore(){
		betScore = 0;
		l._class('bet-score').dom.innerHTML = 0;
	}
//游戏逻辑结束
	l.id('bet').click(addBetScore)
	l.id('clearBet').click(clearBetScore)
	l.id('start').click(run)

	l().on('keyup',function(ev){
		l.id('start').dom.blur();
		l.id('bet').dom.blur();
		l.id('clearBet').dom.blur();

		var e = ev || event;
		// alert(e.keyCode)
		switch(e.keyCode){
			case 13:
				run();
				break;
			case 32:
				addBetScore();
				break;
			case 67:
				clearBetScore();
				break;
		}

		if(e.keyCode > 48 && e.keyCode < 54){
			change.call(pokerCard[e.keyCode-49].dom)
		}
	})
}())

</script>
</body>
</html>